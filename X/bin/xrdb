#!/bin/bash

cpp=$(type -P cpp)
if [[ ! -n $cpp ]]; then
    echo "$0: missing cpp, aborting" >&2
    exit 1
fi

def_hostname=${HOSTNAME%%.*}
def_hostname=${def_hostname//[^[:word:]]/_}

cmd=$(printf '%q ' \
    "$(wrapped $0)" \
    -cpp "$cpp" \
    -DHOST_$def_hostname=1 -DUSER_$USER=1 \
    $(if [[ $DISPLAY == :[0-9]* ]]; then
        if [[ -n $NXDIR ]]; then
            echo -DDISPLAY_IS_NX=1
        else
            echo -DDISPLAY_IS_LOCAL=1
        fi
    fi) \
    $([[ -s ~/.nite ]] && echo -DMODE_$(<~/.nite)=1) \
    ${XFT_RESOURCES:+-DXFT_RESOURCES="$XFT_RESOURCES"}
)

# this is prequoted
if [[ -x ~/.xrdb.local ]]; then
    cmd+=" $(~/.xrdb.local | xargs -d\\n)"
fi

if [[ $# -gt 0 ]]; then
    cmd+=" $(printf '%q ' "$@")"
fi

echo "$cmd"
eval "exec $cmd"
