#!/bin/bash

user_ui_props=$HOME/.crashplan/conf/ui.properties
user_ui_info=$HOME/.crashplan/.ui_info
root_ui_info=/var/lib/crashplan/.ui_info

cleanup() {
    trap - 0
    if [[ -e $user_ui_info.orig ]]; then
        mv -f $user_ui_info{.orig,}
    fi

    # Old method, but seems to still be required.
    sed -i '/servicePort/d' $user_ui_props
}
trap 'cleanup; exit' 0 1 2 3 15

cleanup

if [[ -n $1 ]]; then
    cp -b $user_ui_info{,.orig} || exit
    ssh $1 "cat $root_ui_info $user_ui_info 2>/dev/null" > $user_ui_info

    # Old method, but seems to still be required.
    echo 'servicePort=4200' >> ~/.crashplan/conf/ui.properties
fi

~/.crashplan/bin/CrashPlanDesktop

if [[ -n $1 ]]; then
    ui_info=$(<$user_ui_info)
    port=${ui_info%%,*}
    echo -n "4200,${ui_info#*,}" > $user_ui_info
    echo "Press ctrl-c when done..."
    ssh -L 4200:localhost:$port $1 sleep 99999
fi
