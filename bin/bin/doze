#!/bin/bash

main() {
    declare cmd
    declare -a opts

    set_cmd_opts
    add_geometry_opt

    opts+=( $DOZEARGS "$@" )

    if [[ $# -eq 0 ]] || ! getent hosts ${!#%:*} &>/dev/null; then
        opts+=( $DOZEHOST )
    fi

    set -x
    exec $cmd "${opts[@]}"
}

set_cmd_opts() {
    if has xfreerdp || ! has rdesktop; then
        cmd=xfreerdp
        opts=( -z -x b --plugin cliprdr --plugin rdpsnd )

        declare p=$(lpq 2>/dev/null | head -n1)
        if [[ $p == *' is ready' ]]; then
            #opts+=( --plugin rdpdr --data printer: )
            opts+=( --plugin rdpdr --data printer:${p%% *} -- )
        fi
    else
        cmd="$(pactl stat &>/dev/null && type -P padsp) rdesktop"
        opts=( -z -E -x b -P -r sound:local )

        declare p=$(lpq 2>/dev/null | head -n1)
        if [[ $p == *' is ready' ]]; then
            opts+=( -r printer:${p%% *} )
        fi
    fi
}

add_geometry_opt() {
    case ${0##*/} in
        windoze)
            if [[ -z $WINDOWID ]]; then
                exec run_term -e bash -c "setsid $(printf '%q ' "$0" "$@") & sleep 3"
            fi
            opts+=( -g $(xwininfo -id $WINDOWID | awk '
                            $1=="Width:"{x=$2}
                            $1=="Height:"{y=$2}
                            END{print x"x"y}') )
            ;;

        *) 
            # cmdline will override if given
            workarea=$(xprop -root _NET_WORKAREA | sed 's/,//g' | \
                awk '{printf "%dx%d", $5-20, $6-30}')
            opts+=( -g $workarea )
            ;;
    esac
}

has() {
    type -P "$1" &>/dev/null
}

main "$@"
