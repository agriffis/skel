#!/bin/bash

msg=$(cat)
enc=$(gpg --batch --encrypt --armor ${2:+--trusted-key "$2"} --recipient "${2:-$1}" \
    <<<$'Content-Type: message/rfc822\nContent-Disposition: inline\n\n'"$msg") || exit 1
boundary=$(date +'%s.%N' | md5sum | cut -d' ' -f1)

if [[ $(grep -m1 . <<<"$msg") == From\ *@* ]]; then
    hdr=$(perl -00 -ne '/\S/ or next; s/\n[^\S\n]+/ /g; print; exit' <<<"$msg")
    date=$(grep -m1 ^Date: <<<"$hdr")
    subj=$(grep -m1 ^Subject: <<<"$hdr")
fi

: ${date:="Date: $(date -R)"}
: ${subj:="Subject: Encrypted message from Aron Griffis"}

at=@
cat <<EOF
$date
From: Aron Griffis <aron${at}hp.com>
To: $1
Bcc: aron${at}hp.com
$subj
X-encrypt-to: $2
Content-Type: multipart/encrypted; protocol="application/pgp-encrypted";
	boundary="$boundary"
Content-Disposition: inline

--$boundary
Content-Type: application/pgp-encrypted
Content-Disposition: attachment

Version: 1

--$boundary
Content-Type: application/octet-stream
Content-Disposition: inline; filename="msg.asc"

$enc

--$boundary
EOF
