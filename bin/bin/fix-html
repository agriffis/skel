#!/bin/bash

set -e

tmpfiles=()
trap 'rm -f "${tmpfiles[@]}"; exit' 0 1 2 15

html=$1

if [[ -z $html || ! -f $html ]]; then
    # named pipe? we need something we can scan multiple times.
    t=$(mktemp --suffix=html)
    tmpfiles+=( "$t" )
    cat ${html:+< "$html"} > "$t"
    html=$t
fi

exchange_msg='<meta name="Generator" content="Microsoft Exchange Server">'
outlook_msg='<meta name="?Generator"? content="Microsoft Word'

if head -n10 "$html" | egrep -qe "$exchange_msg|$outlook_msg"; then
    perl -i -0777 -pe '
        s{<o:p>(?:.nbsp;)*(.*?)</o:p>}{$1}gs;
        s{<p\s+class="?MsoPlainText"?>(.*?)</p>}{<tt>$1</tt><br>}gs;
        s{<p\s+class="?MsoNormal"?>(.*?)</p>}{$1<br>}gs;
        s{<td\s+width=\d+}{<td }gs;
        ' "$html"
fi

perl -i -0777 -pe '
    s{<span\s+style=\S+font-family:Wingdings[^>]*>J</span>}{:-)}gs;
    s{<table\s}{$& border=1}gs;
    ' "$html"

export RAN_HTML_FIXUPS=1

cat "$html"
#run-mailcap --action=cat text/html:"$html"
