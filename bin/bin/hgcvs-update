#!/bin/bash
# $Id: hgcvs-update 3885 2010-02-18 15:26:31Z agriffis $
#
# hgcvs-update
#
# Copyright 2007 Aron Griffis <agriffis@n01se.net>
# Released under the MIT License, see
# http://www.opensource.org/licenses/mit-license.php
#
# First...
# 1. Check out the cvs project: cvs co -d server proj
# 2. Run hgcvs-update for the first time: hgcvs-update proj
# 3. Clone the repo to do your work: hg clone proj proj-work
# 4. Make changes in proj-work
#
# Later...
# 1. Rerun hgcvs-update to refresh from cvs
# 2. Use hg to pull and merge changesets in proj-work

if [[ -n $1 ]]; then
    cd "$1" || exit
fi

if [[ ! -d CVS ]]; then
    echo "Please run this from within the cvs checkout" >&2
    exit 1
fi

cvsout=$(cvs up 2>&1) || exit 1
cvsout=$(grep -Fxv -e '? .hg' -e '? .hgignore' <<<"$cvsout")
if grep '^[ARMC?] ' <<<"$cvsout"; then
    echo "CVS checkout is tainted"
    exit 1
fi

if [[ ! -d .hg ]]; then
    echo CVS > .hgignore
    hg init && hg add && hg ci -m "First commit from cvs"
    exit
fi

[[ -z $cvsout ]] && exit
hg add
hg remove --after
hg ci -m "Update from cvs"
