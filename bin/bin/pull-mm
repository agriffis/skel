#!/bin/bash
#
# To use this script, first clone http://kernel.org/hg/linux-2.6/ or a mirror,
# then run the script.  For example,
#
#       hg clone http://hg.intevation.de/mirrors/kernel.org/linux-2.6/
#       ./update-mm
#
# A companion repository will be created, called linux-2.6-mm by default.  You
# can run update-mm whenever you want to keep the repository up to date.

set -ex

linux26=linux-2.6
linux26mm=${1:-linux-2.6-mm}
cd "$(dirname "$linux26mm")"
linux26mm=${linux26mm##*/}

if [[ ! -d $linux26 ]]; then
    echo "where is $linux26?" >&2
    exit 1
fi

mm=$(wget -o/dev/null -O- http://www.kernel.org/kdist/finger_banner | \
    awk '/latest -mm patch/{print $NF}')
if [[ -z $mm ]]; then
    exit 1
fi
if hg -R $linux26mm tags | grep -Fw v$mm; then
    exit 0
fi
base=${mm%-mm*}
url=http://kernel.org/pub/linux/kernel/people/akpm/patches/2.6/$base/$mm/$mm.bz2
trap "rm -f $PWD/$mm.bz2;exit" 0
wget -c $url

if cd $linux26mm 2>/dev/null; then
    hg pull
else
    hg clone -U $linux26 $linux26mm
    cd $linux26mm
fi
hg up -C v$base
if hg st | grep -q .; then
    echo "repository is not clean, aborting" >&2
    exit 1
fi
bzcat ../$mm.bz2 | hg import -m "$url" -
hg tag v$mm
