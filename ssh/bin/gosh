#!/usr/bin/env bash

main() {
  ensure-ssh-identity "$@"

  declare host="${1:-junco}"
  shift

  # Use VPN or not
  declare dom=scampernet
  if [[ $host == *.* ]]; then
    dom=${host#*.}
    host=${host%%.*}
  elif grep -q tail71bb0 /etc/resolv.conf; then
    dom=tail71bb0.ts.net
  fi

  case $host in
    advent) host=junco session=advent ;;
    gargan) host=gargan session=scampersand ;;
    junco) host=junco session=scampersand ;;
    jx) host=junco session=jx ;;
  esac

  if [[ $# == 0 ]]; then
    # -E to avoid wiping out DISPLAY set by tunnel
    set -- "$host.$dom" "tmux new-session -ADEs $session"
  fi

  case ${HOSTNAME%%.*}/${0##*/} in
    */gosh)
      # mosh handles quoting differently from ssh
      eval mosh -- "$@"
      ;;

    */sssh) 
      ssh -t "$@"
      ;;

    *)
      echo "what is $0?" >&2; exit 1
      ;;
  esac

  exit # always exit at bottom of main
}

ensure-ssh-identity() {
  ssh-add -l &>/dev/null
  case $? in
    2)
      # wrap and restart
      exec ssh-agent "$(type -P "$0")" "$@"
      ;;
    0)
      # we have identities, carry on
      ;;
    *)
      # add identity to running ssh-agent
      ssh-add || exit
      ;;
  esac
}

main "$@"
