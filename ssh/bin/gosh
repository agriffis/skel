#!/usr/bin/env bash

main() {
  ensure-ssh-identity "$@"

  declare backend=et
  case $1 in
    et|mosh|ssh) backend=$1; shift ;;
  esac

  declare host="${1:-junco}"
  shift

  # Use VPN or not
  declare dom=scampernet
  if [[ $host == *.* ]]; then
    dom=${host#*.}
    host=${host%%.*}
  elif grep -q tail71bb0 /etc/resolv.conf; then
    dom=tail71bb0.ts.net
  fi

  case $host in
    advent) host=junco.$dom session=advent ;;
    junco) host=junco.$dom session=scampersand ;;
    jx) host=junco.$dom session=jx ;;
  esac

  # -E to avoid wiping out DISPLAY set by tunnel
  declare cmd="tmux new-session -ADEs $session"

  case $backend in
    et) et -c "$cmd" "$host" ;;
    mosh) eval mosh -- "$host" "$cmd" ;;
    ssh) ssh -t "$host" "$cmd" ;;
    *) echo "what is $backend?" >&2; exit 1 ;;
  esac

  exit # always exit at bottom of main
}

ensure-ssh-identity() {
  ssh-add -l &>/dev/null
  case $? in
    2)
      # wrap and restart
      exec ssh-agent "$(type -P "$0")" "$@"
      ;;
    0)
      # we have identities, carry on
      ;;
    *)
      # add identity to running ssh-agent
      ssh-add || exit
      ;;
  esac
}

main "$@"
